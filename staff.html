<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CloudAssist — Staff Inbox</title>

  <style>
    :root{
      --bg:#0b1220;
      --card: rgba(255,255,255,.06);
      --line: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --brand1:#4f46e5;
      --brand2:#06b6d4;
      --good:#22c55e;
      --warn:#fbbf24;
      --bad:#fb7185;
      --shadow: 0 18px 55px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(79,70,229,.28), transparent 60%),
        radial-gradient(900px 600px at 85% 0%, rgba(6,182,212,.22), transparent 55%),
        linear-gradient(180deg, #070b14, var(--bg));
      color: var(--text);
      min-height:100vh;
    }

    .topbar{
      position:sticky; top:0;
      backdrop-filter: blur(10px);
      background: rgba(7,11,20,.55);
      border-bottom: 1px solid var(--line);
      z-index:10;
    }
    .topbar-inner{
      max-width: 1180px;
      margin: 0 auto;
      padding: 14px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
    }

    .brand{ display:flex; align-items:center; gap:12px; }
    .logo{
      width:44px; height:44px; border-radius:14px;
      background: linear-gradient(135deg, var(--brand1), var(--brand2));
      box-shadow: 0 14px 40px rgba(79,70,229,.28);
      display:grid; place-items:center;
      font-weight:800;
      letter-spacing:.4px;
    }
    .brand h1{ font-size:15px; margin:0; }
    .brand p{ font-size:12px; margin:2px 0 0; color: var(--muted); }

    .navpill{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
    .pill{
      font-size:12px;
      padding:8px 10px;
      border: 1px solid var(--line);
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      color: var(--muted);
      text-decoration:none;
      display:inline-flex;
      gap:8px;
      align-items:center;
    }
    .pill strong{ color: var(--text); font-weight:600; }

    main{
      max-width: 1180px;
      margin: 0 auto;
      padding: 20px 18px 56px;
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 16px;
      align-items:start;
    }
    @media (max-width: 980px){
      main{ grid-template-columns: 1fr; }
    }

    .card{
      border-radius: var(--radius);
      border: 1px solid var(--line);
      background: linear-gradient(180deg, var(--card), rgba(255,255,255,.04));
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .card-head{
      padding: 16px 18px;
      border-bottom: 1px solid var(--line);
      background: linear-gradient(90deg, rgba(79,70,229,.14), rgba(6,182,212,.10));
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .card-head h2{ margin:0; font-size:18px; letter-spacing:-.2px; }
    .sub{ margin:0; color: var(--muted); font-size:12px; }

    .toolbar{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }

    input, select, textarea{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: var(--text);
      padding: 10px 10px;
      outline:none;
      font-size: 13px;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(6,182,212,.55);
      box-shadow: 0 0 0 4px rgba(6,182,212,.12);
    }

    table{
      width:100%;
      border-collapse: collapse;
    }
    th, td{
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      vertical-align: top;
      font-size: 13px;
    }
    th{
      color: rgba(255,255,255,.72);
      font-weight:600;
      text-align:left;
      font-size: 12px;
      letter-spacing:.2px;
    }
    tr:hover td{
      background: rgba(255,255,255,.03);
      cursor:pointer;
    }

    .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-size: 12px;
      color: rgba(255,255,255,.82);
      white-space:nowrap;
    }
    .dot{ width:8px; height:8px; border-radius:999px; background: var(--warn); }
    .dot.new{ background: var(--warn); }
    .dot.progress{ background: #60a5fa; }
    .dot.resolved{ background: var(--good); }

    .muted{ color: var(--muted); font-size: 12px; }

    .empty{
      padding: 22px 18px;
      color: var(--muted);
      font-size: 13px;
    }

    .detail{
      padding: 16px 18px;
      display:grid;
      gap: 12px;
    }
    .kv{
      display:grid;
      gap: 6px;
    }
    .kv label{
      font-size: 12px;
      color: var(--muted);
    }
    .kv .value{
      font-size: 13px;
      line-height: 1.45;
      white-space: pre-wrap;
    }

    .btn{
      border:0;
      border-radius: 999px;
      padding: 10px 12px;
      font-size: 13px;
      cursor:pointer;
      color:white;
      background: linear-gradient(135deg, var(--brand1), var(--brand2));
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      transition: transform .08s ease, opacity .12s ease;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{
      background: rgba(255,255,255,.06);
      border: 1px solid var(--line);
      color: var(--muted);
    }

    .statusbox{
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.05);
      font-size: 12px;
      color: var(--muted);
      white-space: pre-wrap;
    }
    .ok{ border-color: rgba(34,197,94,.35); color: rgba(34,197,94,.95); }
    .err{ border-color: rgba(251,113,133,.35); color: rgba(251,113,133,.95); }

    .split{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo">CA</div>
        <div>
          <h1>CloudAssist</h1>
          <p>Staff Inbox — triage and resolve enquiries in real time.</p>
        </div>
      </div>

      <div class="navpill">
        <a class="pill" href="public.html">Public</a>
        <div class="pill"><strong>Staff</strong></div>
        <a class="pill" href="insights.html">Insights</a>
      </div>
    </div>
  </header>

  <main>
      <!-- Demo Login Credentials (for markers) -->
  <section class="card" style="margin-bottom:16px;">
    <div class="card-head">
      <div>
        <h2>Staff Login (Demo Access)</h2>
        <p class="sub">
          Demo credentials provided for marking access.
        </p>
      </div>
    </div>

    <div class="detail">
      <div class="statusbox ok" style="display:block;">
        Username: <strong>staff@cloudassist.com</strong><br>
        Password: <strong>cloudassist123</strong>
      </div>

      <p class="muted">
        Note: This prototype does not implement authentication. In a production
        system, secure login would be handled using Firebase Authentication.
      </p>
    </div>
  </section>

    <!-- LEFT: INBOX TABLE -->
    <section class="card">
      <div class="card-head">
        <div>
          <h2>Enquiry Inbox</h2>
          <p class="sub" id="countLine">Loading…</p>
        </div>

        <div class="toolbar">
          <input id="search" type="search" placeholder="Search name / email / message" />
          <select id="filter">
            <option value="ALL">All statuses</option>
            <option value="New">New</option>
            <option value="In Progress">In Progress</option>
            <option value="Resolved">Resolved</option>
          </select>
        </div>
      </div>

      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>Status</th>
              <th>Customer</th>
              <th>Message (preview)</th>
              <th>Created</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>

      <div id="empty" class="empty" style="display:none;">
        No enquiries yet. Submit one from the Public page to see it appear here instantly.
      </div>
    </section>

    <!-- RIGHT: DETAIL / UPDATE PANEL -->
    <aside class="card">
      <div class="card-head">
        <div>
          <h2>Enquiry Details</h2>
          <p class="sub">Select an enquiry to view and update.</p>
        </div>
      </div>

      <div class="detail">
        <div class="statusbox" id="panelHint">
          Waiting for selection…
        </div>

        <div id="panel" style="display:none;">
          <div class="kv">
            <label>Customer</label>
            <div class="value" id="pCustomer"></div>
          </div>

          <div class="kv">
            <label>Email</label>
            <div class="value" id="pEmail"></div>
          </div>

          <div class="kv">
            <label>Message</label>
            <div class="value" id="pMessage"></div>
          </div>

          <div class="split">
            <div class="kv" style="flex:1; min-width: 200px;">
              <label>Status</label>
              <select id="pStatus">
                <option value="New">New</option>
                <option value="In Progress">In Progress</option>
                <option value="Resolved">Resolved</option>
              </select>
            </div>

            <button class="btn" id="saveBtn">Save update</button>
          </div>

          <div class="kv">
            <label>Internal notes (staff only)</label>
            <textarea id="pNotes" rows="5" placeholder="Add notes for staff…"></textarea>
          </div>

          <div class="statusbox" id="saveMsg" style="display:none;"></div>
        </div>
      </div>
    </aside>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, collection, query, orderBy, onSnapshot,
      doc, updateDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // Same config as public.html
    const firebaseConfig = {
      apiKey: "AIzaSyA9L6iMjwfhEwh-h3utln6teGsEFQzsK-8",
      authDomain: "dbc-final-project-313a1.firebaseapp.com",
      projectId: "dbc-final-project-313a1",
      storageBucket: "dbc-final-project-313a1.firebasestorage.app",
      messagingSenderId: "295884707682",
      appId: "1:295884707682:web:42499514404f1176a37e3b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const rowsEl = document.getElementById("rows");
    const emptyEl = document.getElementById("empty");
    const countLine = document.getElementById("countLine");
    const searchEl = document.getElementById("search");
    const filterEl = document.getElementById("filter");

    const panelHint = document.getElementById("panelHint");
    const panel = document.getElementById("panel");
    const pCustomer = document.getElementById("pCustomer");
    const pEmail = document.getElementById("pEmail");
    const pMessage = document.getElementById("pMessage");
    const pStatus = document.getElementById("pStatus");
    const pNotes = document.getElementById("pNotes");
    const saveBtn = document.getElementById("saveBtn");
    const saveMsg = document.getElementById("saveMsg");

    let allDocs = [];
    let selectedId = null;

    function fmtDate(ts){
      try{
        const d = ts?.toDate ? ts.toDate() : null;
        if(!d) return "—";
        return d.toLocaleString();
      } catch { return "—"; }
    }

    function statusDotClass(status){
      if(status === "Resolved") return "resolved";
      if(status === "In Progress") return "progress";
      return "new";
    }

    function escapeHtml(s){
      return (s ?? "").replace(/[&<>"']/g, (c) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
      }[c]));
    }

    function applyFilters(){
      const q = (searchEl.value || "").trim().toLowerCase();
      const f = filterEl.value;

      const filtered = allDocs.filter(d => {
        const blob = `${d.name} ${d.email} ${d.message}`.toLowerCase();
        const matchesSearch = !q || blob.includes(q);
        const matchesFilter = (f === "ALL") || (d.status === f);
        return matchesSearch && matchesFilter;
      });

      renderTable(filtered);
    }

    function renderTable(list){
      rowsEl.innerHTML = "";

      if(list.length === 0){
        emptyEl.style.display = "block";
        countLine.textContent = allDocs.length === 0
          ? "0 enquiries"
          : `No results (filters applied). Total enquiries: ${allDocs.length}`;
        return;
      }

      emptyEl.style.display = "none";
      countLine.textContent = `${list.length} shown · ${allDocs.length} total`;

      for(const d of list){
        const tr = document.createElement("tr");
        tr.dataset.id = d.id;

        const preview = (d.message || "").slice(0, 80) + ((d.message||"").length > 80 ? "…" : "");

        tr.innerHTML = `
          <td>
            <span class="tag">
              <span class="dot ${statusDotClass(d.status)}"></span>
              ${escapeHtml(d.status || "New")}
            </span>
          </td>
          <td>
            <div><strong>${escapeHtml(d.name || "—")}</strong></div>
            <div class="muted">${escapeHtml(d.email || "—")}</div>
          </td>
          <td>${escapeHtml(preview)}</td>
          <td class="muted">${escapeHtml(fmtDate(d.createdAt))}</td>
        `;

        tr.addEventListener("click", () => openPanel(d.id));
        rowsEl.appendChild(tr);
      }
    }

    function openPanel(id){
      const d = allDocs.find(x => x.id === id);
      if(!d) return;

      selectedId = id;
      panelHint.style.display = "none";
      panel.style.display = "block";
      saveMsg.style.display = "none";

      pCustomer.textContent = d.name || "—";
      pEmail.textContent = d.email || "—";
      pMessage.textContent = d.message || "—";
      pStatus.value = d.status || "New";
      pNotes.value = d.internalNotes || "";
    }

    async function saveUpdate(){
      if(!selectedId) return;

      saveBtn.disabled = true;
      saveBtn.style.opacity = "0.75";
      saveMsg.style.display = "block";
      saveMsg.className = "statusbox";
      saveMsg.textContent = "Saving…";

      try{
        await updateDoc(doc(db, "enquiries", selectedId), {
          status: pStatus.value,
          internalNotes: pNotes.value,
          updatedAt: serverTimestamp()
        });

        saveMsg.className = "statusbox ok";
        saveMsg.textContent = "Saved ✅ (This will update Insights in real time.)";
      } catch(err){
        console.error(err);
        saveMsg.className = "statusbox err";
        saveMsg.textContent = "Save failed ❌ " + (err?.message || "");
      } finally {
        saveBtn.disabled = false;
        saveBtn.style.opacity = "1";
      }
    }

    saveBtn.addEventListener("click", saveUpdate);
    searchEl.addEventListener("input", applyFilters);
    filterEl.addEventListener("change", applyFilters);

    // Real-time listener
    const q = query(collection(db, "enquiries"), orderBy("createdAt", "desc"));
    onSnapshot(q, (snap) => {
      allDocs = snap.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));

      // Keep panel updated if selected doc changes
      if(selectedId){
        const still = allDocs.find(x => x.id === selectedId);
        if(still){
          pStatus.value = still.status || "New";
          pNotes.value = still.internalNotes || "";
        }
      }
      applyFilters();
    }, (err) => {
      console.error(err);
      emptyEl.style.display = "block";
      emptyEl.textContent = "Error loading enquiries: " + (err?.message || "");
    });
  </script>
</body>
</html>
